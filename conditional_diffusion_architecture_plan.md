# æ¡ä»¶æ‰©æ•£æ¶æ„è®¾è®¡æ–‡æ¡£

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

å°†ç°æœ‰çš„D3PMç¦»æ•£æ‰©æ•£æ¨¡å‹æ‰©å±•ä¸ºæ¡ä»¶æ‰©æ•£æ¨¡å‹ï¼Œé€šè¿‡æ·±åº¦èåˆESM-2è›‹ç™½è´¨è¯­è¨€æ¨¡å‹ç‰¹å¾ï¼Œå®ç°åŸºäºå‚è€ƒåºåˆ—çš„æŠ—èŒè‚½æ¡ä»¶ç”Ÿæˆã€‚

## ğŸ¯ æ ¸å¿ƒç›®æ ‡

1. **æ·±åº¦æ¡ä»¶èåˆ**ï¼šå°†ESM-2ç‰¹å¾æ·±åº¦é›†æˆåˆ°D3PMæ‰©æ•£è¿‡ç¨‹ä¸­
2. **é«˜æ•ˆç‰¹å¾æå–**ï¼šè®¾è®¡å¤šå±‚ESM-2ç‰¹å¾æå–å’Œç¼“å­˜ç³»ç»Ÿ
3. **ç§‘ç ”ä»·å€¼æœ€å¤§åŒ–**ï¼šåˆ›å»ºå…·æœ‰å‘è¡¨æ½œåŠ›çš„æ¡ä»¶ç”Ÿæˆæ–¹æ³•
4. **ç³»ç»Ÿå®Œæ•´æ€§**ï¼šä¸ç°æœ‰è®­ç»ƒå’Œæ¨ç†ç³»ç»Ÿæ— ç¼é›†æˆ

## âœ… å·²å®Œæˆå·¥ä½œ

### 1. **æ•°å­¦æ¡†æ¶è®¾è®¡** âœ…
- **æ¡ä»¶æ‰©æ•£ç†è®ºåŸºç¡€**
  ```math
  # åŸå§‹D3PMå‰å‘è¿‡ç¨‹
  q(x_t | x_{t-1}) = Cat(x_t; Î±_t x_{t-1} + (1-Î±_t)/K)
  
  # æ¡ä»¶æ‰©æ•£å‰å‘è¿‡ç¨‹ï¼ˆä¿æŒä¸å˜ï¼‰
  q(x_t | x_{t-1}, c) = q(x_t | x_{t-1})
  
  # æ¡ä»¶æ‰©æ•£åå‘è¿‡ç¨‹ï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼‰
  p_Î¸(x_{t-1} | x_t, c, t) = Cat(x_{t-1}; f_Î¸(x_t, c, t))
  
  # è®­ç»ƒç›®æ ‡
  L = E_{x_0, c, t, x_t} [-log p_Î¸(x_0 | x_t, c, t)]
  ```
- **ESM-2æ¡ä»¶ç‰¹å¾å¤„ç†ç­–ç•¥**
- **Classifier-Free Guidanceæ•°å­¦æ¡†æ¶**

### 2. **æ ¸å¿ƒæ¶æ„è®¾è®¡** âœ…
- **ConditionalD3PMUNetæ¶æ„**
  - æ·±åº¦æ¡ä»¶èåˆæœºåˆ¶
  - æ¯å±‚Transformeréƒ½æœ‰Cross-Attention
  - æ”¯æŒClassifier-Free Guidance
- **ConditionalTransformerLayerè®¾è®¡**
  - è‡ªæ³¨æ„åŠ› + æ¡ä»¶äº¤å‰æ³¨æ„åŠ›
  - æ®‹å·®è¿æ¥å’Œå±‚å½’ä¸€åŒ–
- **æ¡ä»¶åŒ–è®­ç»ƒæŸå¤±å‡½æ•°**

### 3. **ESM-2ç‰¹å¾æå–ç®¡é“è®¾è®¡** âœ…
- **ConditionalESM2FeatureExtractor**
  - å¤šå±‚ç‰¹å¾æå–ï¼ˆLayer 6, 12, 18, 24ï¼‰
  - æ™ºèƒ½ç¼“å­˜ç³»ç»Ÿ
  - å¤šç§æ± åŒ–ç­–ç•¥ï¼ˆAttention/Mean/Maxï¼‰
- **ConditionalFeatureManager**
  - é¢„è®¡ç®—ç‰¹å¾ç®¡ç†
  - æ‰¹é‡å¤„ç†ä¼˜åŒ–
  - æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡

## ğŸ”„ å®ç°è®¡åˆ’

### Phase 1: æ ¸å¿ƒç»„ä»¶å®ç° (P0 - å…³é”®è·¯å¾„)

#### 1.1 ESM-2ç‰¹å¾æå–å™¨å®ç°
- **æ–‡ä»¶**: `enhanced_architecture/conditional_esm2_extractor.py`
- **åŠŸèƒ½**:
  - å®ç°ConditionalESM2FeatureExtractorç±»
  - å¤šå±‚ç‰¹å¾æå–å’Œèåˆ
  - ç¼“å­˜ç³»ç»Ÿå®ç°
- **é¢„è®¡æ—¶é—´**: 2-3å¤©
- **ä¾èµ–**: ç°æœ‰ESM-2å®ç°

#### 1.2 æ¡ä»¶æ‰©æ•£æ¨¡å‹å®ç°
- **æ–‡ä»¶**: `gram_predictor/diffusion_models/conditional_d3pm.py`
- **åŠŸèƒ½**:
  - å®ç°ConditionalD3PMUNet
  - å®ç°ConditionalTransformerLayer
  - æ¡ä»¶åŒ–è®­ç»ƒæŸå¤±
- **é¢„è®¡æ—¶é—´**: 3-4å¤©
- **ä¾èµ–**: ç°æœ‰D3PMå®ç°

#### 1.3 æ•°æ®é…å¯¹ç­–ç•¥è®¾è®¡
- **æ–‡ä»¶**: `gram_predictor/data/conditional_dataset.py`
- **åŠŸèƒ½**:
  - å®šä¹‰å‚è€ƒåºåˆ—-ç›®æ ‡åºåˆ—é…å¯¹è§„åˆ™
  - å®ç°ConditionalDatasetç±»
  - æ•°æ®é¢„å¤„ç†ç®¡é“
- **é¢„è®¡æ—¶é—´**: 2å¤©
- **ä¾èµ–**: ç°æœ‰æ•°æ®åŠ è½½å™¨

### Phase 2: è®­ç»ƒé›†æˆ (P1)

#### 2.1 æ¡ä»¶è®­ç»ƒæµç¨‹
- **æ–‡ä»¶**: `enhanced_architecture/conditional_trainer.py`
- **åŠŸèƒ½**:
  - ä¿®æ”¹è®­ç»ƒå¾ªç¯æ”¯æŒæ¡ä»¶è¾“å…¥
  - å®ç°æ¡ä»¶éªŒè¯æŒ‡æ ‡
  - é›†æˆç‰¹å¾æå–å™¨
- **é¢„è®¡æ—¶é—´**: 3-4å¤©
- **ä¾èµ–**: Phase 1å®Œæˆ

#### 2.2 æ¨ç†å’Œç”Ÿæˆ
- **æ–‡ä»¶**: `gram_predictor/conditional_generation_service.py`
- **åŠŸèƒ½**:
  - æ¡ä»¶ç”Ÿæˆæ¥å£
  - Classifier-Free Guidanceé‡‡æ ·
  - å¤šç§æ¡ä»¶é‡‡æ ·ç­–ç•¥
- **é¢„è®¡æ—¶é—´**: 2-3å¤©
- **ä¾èµ–**: Phase 1å®Œæˆ

### Phase 3: ç³»ç»Ÿé›†æˆå’Œä¼˜åŒ– (P2)

#### 3.1 é…ç½®ç®¡ç†æ›´æ–°
- **æ–‡ä»¶**: `gram_predictor/config/conditional_config.py`
- **åŠŸèƒ½**:
  - æ¡ä»¶æ‰©æ•£é…ç½®å‚æ•°
  - è¶…å‚æ•°ç®¡ç†
  - å®éªŒé…ç½®æ¨¡æ¿
- **é¢„è®¡æ—¶é—´**: 1å¤©

#### 3.2 è¯„ä¼°æ¡†æ¶
- **æ–‡ä»¶**: `evaluation/conditional_evaluator.py`
- **åŠŸèƒ½**:
  - æ¡ä»¶ç”Ÿæˆè´¨é‡è¯„ä¼°
  - ä¸å‚è€ƒåºåˆ—ç›¸ä¼¼åº¦è®¡ç®—
  - ç”Ÿç‰©å­¦æœ‰æ•ˆæ€§éªŒè¯
- **é¢„è®¡æ—¶é—´**: 2-3å¤©

#### 3.3 WebæœåŠ¡é›†æˆ
- **æ–‡ä»¶**: `gram_predictor/conditional_generation_service.py`
- **åŠŸèƒ½**:
  - REST APIæ‰©å±•
  - æ¡ä»¶ç”Ÿæˆç«¯ç‚¹
  - æ‰¹é‡å¤„ç†æ”¯æŒ
- **é¢„è®¡æ—¶é—´**: 1-2å¤©

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„å›¾

```mermaid
graph TB
    subgraph "æ•°æ®å±‚"
        A[Reference Sequences] --> B[ConditionalDataset]
        C[Target Sequences] --> B
        B --> D[DataLoader]
    end
    
    subgraph "ç‰¹å¾æå–å±‚"
        D --> E[ConditionalESM2FeatureExtractor]
        E --> F[Multi-layer Features<br/>L6, L12, L18, L24]
        F --> G[Feature Fusion]
        G --> H[Condition Vector c]
    end
    
    subgraph "æ¡ä»¶æ‰©æ•£å±‚"
        I[Noisy Sequence x_t] --> J[ConditionalD3PMUNet]
        H --> J
        K[Time Step t] --> J
        J --> L[Predicted x_0]
    end
    
    subgraph "è®­ç»ƒå±‚"
        M[ConditionalTrainer] --> N[Training Loop]
        N --> O[Conditional Loss]
        O --> P[Backpropagation]
    end
    
    subgraph "æ¨ç†å±‚"
        Q[Reference Input] --> R[Feature Extraction]
        R --> S[Conditional Sampling]
        S --> T[Generated Sequences]
    end
```

## ğŸ“Š å…³é”®æŠ€æœ¯ç‰¹æ€§

### 1. **æ·±åº¦æ¡ä»¶èåˆ**
- **åˆå§‹èåˆ**: Cross-Attentionæœºåˆ¶
- **å±‚çº§èåˆ**: æ¯ä¸ªTransformerå±‚éƒ½æœ‰æ¡ä»¶äº¤å‰æ³¨æ„åŠ›
- **ç‰¹å¾å¢å¼º**: å¤šå±‚ESM-2ç‰¹å¾çš„åŠ æƒç»„åˆ

### 2. **é«˜æ•ˆç‰¹å¾ç®¡ç†**
- **å¤šå±‚æå–**: åŒæ—¶ä½¿ç”¨ESM-2çš„å¤šä¸ªå±‚ç‰¹å¾
- **æ™ºèƒ½ç¼“å­˜**: åŸºäºåºåˆ—å“ˆå¸Œçš„ç‰¹å¾ç¼“å­˜
- **é¢„è®¡ç®—ä¼˜åŒ–**: å¸¸ç”¨åºåˆ—ç‰¹å¾é¢„è®¡ç®—

### 3. **çµæ´»é‡‡æ ·ç­–ç•¥**
- **Classifier-Free Guidance**: å¯æ§çš„æ¡ä»¶å¼ºåº¦
- **å¤šæ ·æ€§é‡‡æ ·**: é˜²æ­¢æ¨¡å¼åå¡Œ
- **æ¸©åº¦æ§åˆ¶**: ç”Ÿæˆéšæœºæ€§è°ƒèŠ‚

### 4. **ç§‘ç ”å¯¼å‘è®¾è®¡**
- **æ¶ˆèå®éªŒå‹å¥½**: æ¨¡å—åŒ–è®¾è®¡ä¾¿äºå¯¹æ¯”å®éªŒ
- **æŒ‡æ ‡å®Œæ•´**: å¤šç»´åº¦è¯„ä¼°ç”Ÿæˆè´¨é‡
- **å¯è§£é‡Šæ€§**: æ³¨æ„åŠ›æƒé‡å¯è§†åŒ–

## ğŸ”¬ å®éªŒè®¾è®¡æ¡†æ¶

### æ¶ˆèå®éªŒè®¡åˆ’
1. **æ¡ä»¶èåˆæ–¹å¼å¯¹æ¯”**
   - ç®€å•ç‰¹å¾æ‹¼æ¥ vs Cross-Attention
   - å•å±‚èåˆ vs å¤šå±‚èåˆ
   - ä¸åŒESM-2å±‚çš„æ•ˆæœ

2. **é‡‡æ ·ç­–ç•¥å¯¹æ¯”**
   - æ ‡å‡†é‡‡æ · vs CFGé‡‡æ ·
   - ä¸åŒguidance scaleçš„å½±å“
   - æ¸©åº¦å‚æ•°è°ƒä¼˜

3. **ç‰¹å¾æå–ç­–ç•¥å¯¹æ¯”**
   - ä¸åŒæ± åŒ–æ–¹æ³•æ•ˆæœ
   - å¤šå±‚ç‰¹å¾ç»„åˆç­–ç•¥
   - ç¼“å­˜ç³»ç»Ÿæ€§èƒ½åˆ†æ

### è¯„ä¼°æŒ‡æ ‡
- **ç”Ÿæˆè´¨é‡**: BLEU, ç¼–è¾‘è·ç¦», åºåˆ—å¤šæ ·æ€§
- **æ¡ä»¶ä¸€è‡´æ€§**: ä¸å‚è€ƒåºåˆ—çš„ç›¸ä¼¼åº¦
- **ç”Ÿç‰©å­¦æœ‰æ•ˆæ€§**: æŠ—èŒæ´»æ€§é¢„æµ‹, ç†åŒ–æ€§è´¨åˆ†æ
- **è®¡ç®—æ•ˆç‡**: æ¨ç†é€Ÿåº¦, å†…å­˜ä½¿ç”¨, ç¼“å­˜å‘½ä¸­ç‡

## ğŸ“ æ–‡ä»¶ç»“æ„è§„åˆ’

```
gram_predictor/
â”œâ”€â”€ diffusion_models/
â”‚   â”œâ”€â”€ d3pm_diffusion.py                 # ç°æœ‰D3PMå®ç°
â”‚   â”œâ”€â”€ conditional_d3pm.py               # æ–°å¢ï¼šæ¡ä»¶æ‰©æ•£å®ç°
â”‚   â””â”€â”€ conditional_scheduler.py          # æ–°å¢ï¼šæ¡ä»¶è°ƒåº¦å™¨
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ data_loader.py                    # ç°æœ‰æ•°æ®åŠ è½½å™¨
â”‚   â””â”€â”€ conditional_dataset.py            # æ–°å¢ï¼šæ¡ä»¶æ•°æ®é›†
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ model_config.py                   # ç°æœ‰é…ç½®
â”‚   â””â”€â”€ conditional_config.py             # æ–°å¢ï¼šæ¡ä»¶æ‰©æ•£é…ç½®
â”œâ”€â”€ web/
â”‚   â””â”€â”€ conditional_api.py                # æ–°å¢ï¼šæ¡ä»¶ç”ŸæˆAPI
â”œâ”€â”€ generation_service.py                 # ç°æœ‰ç”ŸæˆæœåŠ¡
â””â”€â”€ conditional_generation_service.py     # æ–°å¢ï¼šæ¡ä»¶ç”ŸæˆæœåŠ¡

enhanced_architecture/
â”œâ”€â”€ esm2_auxiliary_encoder.py             # ç°æœ‰ESM-2å®ç°
â”œâ”€â”€ conditional_esm2_extractor.py         # æ–°å¢ï¼šæ¡ä»¶ç‰¹å¾æå–å™¨
â”œâ”€â”€ conditional_loss.py                   # æ–°å¢ï¼šæ¡ä»¶æŸå¤±å‡½æ•°
â”œâ”€â”€ main_trainer.py                       # ç°æœ‰è®­ç»ƒå™¨
â””â”€â”€ conditional_trainer.py                # æ–°å¢ï¼šæ¡ä»¶è®­ç»ƒå™¨

evaluation/
â””â”€â”€ conditional_evaluator.py              # æ–°å¢ï¼šæ¡ä»¶è¯„ä¼°æ¡†æ¶

experiments/
â”œâ”€â”€ conditional_experiment_manager.py     # æ–°å¢ï¼šå®éªŒç®¡ç†
â””â”€â”€ configs/                              # å®éªŒé…ç½®æ–‡ä»¶
    â”œâ”€â”€ baseline_config.yaml
    â”œâ”€â”€ ablation_configs/
    â””â”€â”€ production_config.yaml

utils/
â”œâ”€â”€ conditional_metrics.py                # æ–°å¢ï¼šæ¡ä»¶ç”ŸæˆæŒ‡æ ‡
â””â”€â”€ visualization.py                      # æ–°å¢ï¼šç»“æœå¯è§†åŒ–
```

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³å¼€å§‹ (æœ¬å‘¨)
1. **å®ç°ConditionalESM2FeatureExtractor** - ç‰¹å¾æå–æ˜¯æ•´ä¸ªç³»ç»Ÿçš„åŸºç¡€
2. **è®¾è®¡æ•°æ®é…å¯¹ç­–ç•¥** - å®šä¹‰è®­ç»ƒæ•°æ®çš„ç»„ç»‡æ–¹å¼
3. **å®ç°ConditionalD3PMUNet** - æ ¸å¿ƒæ¡ä»¶æ‰©æ•£æ¨¡å‹

### çŸ­æœŸç›®æ ‡ (2å‘¨å†…)
1. **å®ŒæˆåŸºç¡€æ¡ä»¶è®­ç»ƒ** - è®©ç³»ç»Ÿèƒ½å¤Ÿè¿›è¡Œæ¡ä»¶è®­ç»ƒ
2. **å®ç°æ¡ä»¶ç”Ÿæˆ** - åŸºç¡€çš„æ¡ä»¶åºåˆ—ç”ŸæˆåŠŸèƒ½
3. **åˆæ­¥å®éªŒéªŒè¯** - éªŒè¯æ¡ä»¶ç”Ÿæˆçš„æœ‰æ•ˆæ€§

### ä¸­æœŸç›®æ ‡ (1ä¸ªæœˆå†…)
1. **å®Œæ•´è¯„ä¼°æ¡†æ¶** - å…¨é¢çš„ç”Ÿæˆè´¨é‡è¯„ä¼°
2. **ç³»ç»Ÿä¼˜åŒ–** - æ€§èƒ½ä¼˜åŒ–å’Œç¨³å®šæ€§æå‡
3. **å®éªŒåˆ†æ** - å®Œæ•´çš„æ¶ˆèå®éªŒå’Œç»“æœåˆ†æ

## ğŸ’¡ æŠ€æœ¯é£é™©å’Œç¼“è§£ç­–ç•¥

### é£é™©1: ESM-2ç‰¹å¾æå–æ•ˆç‡
- **é£é™©**: å¤§æ¨¡å‹æ¨ç†é€Ÿåº¦æ…¢ï¼Œå½±å“è®­ç»ƒæ•ˆç‡
- **ç¼“è§£**: æ™ºèƒ½ç¼“å­˜ç³»ç»Ÿ + é¢„è®¡ç®—ç­–ç•¥

### é£é™©2: æ¡ä»¶èåˆæ•ˆæœä¸ä½³
- **é£é™©**: ç®€å•çš„ç‰¹å¾èåˆå¯èƒ½æ•ˆæœæœ‰é™
- **ç¼“è§£**: å¤šç§èåˆç­–ç•¥å¯¹æ¯” + æ¶ˆèå®éªŒ

### é£é™©3: è®­ç»ƒç¨³å®šæ€§
- **é£é™©**: æ¡ä»¶æ‰©æ•£è®­ç»ƒå¯èƒ½ä¸ç¨³å®š
- **ç¼“è§£**: æ¸è¿›å¼è®­ç»ƒ + ä»”ç»†çš„è¶…å‚æ•°è°ƒä¼˜

### é£é™©4: ç”Ÿæˆè´¨é‡è¯„ä¼°
- **é£é™©**: ç¼ºä¹æ ‡å‡†çš„æ¡ä»¶ç”Ÿæˆè¯„ä¼°æ–¹æ³•
- **ç¼“è§£**: å¤šç»´åº¦è¯„ä¼°æŒ‡æ ‡ + äººå·¥è¯„ä¼°ç»“åˆ

## ğŸ“ˆ æˆåŠŸæ ‡å‡†

### æŠ€æœ¯æŒ‡æ ‡
- [ ] æ¡ä»¶ç”ŸæˆæˆåŠŸç‡ > 95%
- [ ] ä¸å‚è€ƒåºåˆ—ç›¸ä¼¼åº¦ > 0.7
- [ ] ç”Ÿæˆåºåˆ—å¤šæ ·æ€§ä¿æŒåœ¨åˆç†èŒƒå›´
- [ ] æ¨ç†é€Ÿåº¦ < 10ç§’/åºåˆ—

### ç§‘ç ”ä»·å€¼
- [ ] ç›¸æ¯”æ— æ¡ä»¶ç”Ÿæˆæœ‰æ˜¾è‘—æå‡
- [ ] æ¶ˆèå®éªŒç»“æœæ¸…æ™°
- [ ] æ–¹æ³•å…·æœ‰é€šç”¨æ€§å’Œå¯æ‰©å±•æ€§
- [ ] ä»£ç è´¨é‡è¾¾åˆ°å¼€æºæ ‡å‡†

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2025-06-22  
**æœ€åæ›´æ–°**: 2025-06-22  
**è´Ÿè´£äºº**: Kilo Code & User