<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gram-Negative Bacteria Generation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-virus2"></i> Gram-Negative Bacteria Prediction System
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="bi bi-house-door"></i> Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/generate"><i class="bi bi-plus-circle"></i> Generate</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/about"><i class="bi bi-info-circle"></i> About</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-magic"></i> Generate Gram-Negative Bacteria Peptides</h5>
                    </div>
                    <div class="card-body">
                        <p class="lead">Generate novel anti-gram-negative bacterial peptide sequences using AI diffusion models</p>
                        
                        <!-- Generation Parameters Form -->
                        <form id="generateForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="numSequences" class="form-label">Number of Sequences</label>
                                        <input type="number" class="form-control" id="numSequences" min="1" max="50" value="5">
                                        <div class="form-text">Generate 1-50 sequences</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="seqLength" class="form-label">Sequence Length</label>
                                        <input type="number" class="form-control" id="seqLength" min="10" max="100" value="40">
                                        <div class="form-text">Length: 10-100 amino acids</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="samplingMethod" class="form-label">Sampling Method</label>
                                        <select class="form-select" id="samplingMethod">
                                            <option value="diverse" selected>Diverse Sampling (Recommended)</option>
                                            <option value="top_k">Top-K Sampling</option>
                                            <option value="nucleus">Nucleus Sampling</option>
                                            <option value="basic">Basic Sampling</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="temperature" class="form-label">Temperature</label>
                                        <input type="range" class="form-range" id="temperature" min="0.1" max="2.0" step="0.1" value="1.0">
                                        <div class="form-text">Current: <span id="tempValue">1.0</span> (higher = more random)</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Advanced Parameters -->
                            <div class="mb-3">
                                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#advancedParams">
                                    <i class="bi bi-gear"></i> Advanced Parameters
                                </button>
                            </div>
                            
                            <div class="collapse" id="advancedParams">
                                <div class="card card-body mb-3">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="topK" class="form-label">Top-K Value</label>
                                                <input type="number" class="form-control" id="topK" min="1" max="20" value="10">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="nucleusP" class="form-label">Nucleus P Value</label>
                                                <input type="number" class="form-control" id="nucleusP" min="0.1" max="1.0" step="0.1" value="0.9">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="diversityStrength" class="form-label">Diversity Strength</label>
                                                <input type="number" class="form-control" id="diversityStrength" min="0.0" max="1.0" step="0.1" value="0.3">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Reference Sequences -->
                            <div class="mb-3">
                                <label for="referenceSeqs" class="form-label">Reference Sequences (Optional)</label>
                                <textarea class="form-control" id="referenceSeqs" rows="3" placeholder="Enter reference sequences, one per line, for conditional generation"></textarea>
                                <div class="form-text">Generate similar sequences based on reference sequences</div>
                            </div>
                            
                            <div class="text-center">
                                <button type="submit" class="btn btn-lg btn-success" id="generateBtn">
                                    <i class="bi bi-magic"></i> Generate Sequences
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Loading Status -->
                    <div id="loadingSection" class="text-center mt-4" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Generating...</span>
                        </div>
                        <p class="mt-2">Generating sequences, please wait...</p>
                    </div>
                    
                    <!-- Results Display Area -->
                    <div id="resultsSection" style="display: none;">
                        <div class="card mt-4">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="bi bi-check-circle"></i> Generation Results</h5>
                            </div>
                            <div class="card-body">
                                <div id="generationStats" class="mb-3"></div>
                                <div id="sequenceResults"></div>
                                
                                <!-- Action Buttons -->
                                <div class="text-center mt-3">
                                    <button type="button" class="btn btn-primary" id="predictBtn">
                                        <i class="bi bi-search"></i> Predict Antimicrobial Activity
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="exportBtn">
                                        <i class="bi bi-download"></i> Export Sequences
                                    </button>
                                    <button type="button" class="btn btn-outline-info" id="copyBtn">
                                        <i class="bi bi-clipboard"></i> Copy FASTA
                                    </button>
                                </div>
                                
                                <!-- Prediction Results Display Area -->
                                <div id="predictionResults" style="display: none;" class="mt-4">
                                    <div class="card">
                                        <div class="card-header bg-info text-white">
                                            <h6 class="mb-0"><i class="bi bi-graph-up"></i> Antimicrobial Activity Prediction Results</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="predictionContent"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Error Display Area -->
                    <div id="errorSection" class="alert alert-danger mt-4" style="display: none;">
                        <h6><i class="bi bi-exclamation-triangle"></i> Error</h6>
                        <p id="errorMessage"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="footer mt-5 py-4">
        <div class="container">
            <div class="row">
                <div class="col-12 text-center">
                    <h5>Gram-Negative Bacteria Prediction System</h5>
                    <p class="mb-0">© 2025 Bioinfo Iota</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- JavaScript 依赖 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let generatedSequences = [];
        
        // 温度滑块更新
        document.getElementById('temperature').addEventListener('input', function() {
            document.getElementById('tempValue').textContent = this.value;
        });
        
        // 生成表单提交
        document.getElementById('generateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // 获取表单数据
            const formData = {
                num_sequences: parseInt(document.getElementById('numSequences').value),
                seq_length: parseInt(document.getElementById('seqLength').value),
                sampling_method: document.getElementById('samplingMethod').value,
                temperature: parseFloat(document.getElementById('temperature').value),
                k: parseInt(document.getElementById('topK').value),
                p: parseFloat(document.getElementById('nucleusP').value),
                diversity_strength: parseFloat(document.getElementById('diversityStrength').value),
                reference_sequences: document.getElementById('referenceSeqs').value
                    .split('\n')
                    .map(s => s.trim())
                    .filter(s => s.length > 0)
            };
            
            // 显示加载状态
            showLoading();
            
            try {
                const response = await fetch('/generate_sequences', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    generatedSequences = result.sequences;
                    showResults(result);
                } else {
                    showError(result.error || '生成失败');
                }
            } catch (error) {
                showError('网络错误: ' + error.message);
            }
        });
        
        // Predict button click
        document.getElementById('predictBtn').addEventListener('click', async function() {
            if (generatedSequences.length === 0) {
                alert('Please generate sequences first');
                return;
            }
            
            // Show loading state
            const predictBtn = document.getElementById('predictBtn');
            const originalText = predictBtn.innerHTML;
            predictBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Predicting...';
            predictBtn.disabled = true;
            
            try {
                // 创建FASTA格式数据
                let fastaText = '';
                generatedSequences.forEach(seq => {
                    fastaText += `>${seq.id}\n${seq.sequence}\n`;
                });
                
                // 发送预测请求
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `fasta_text=${encodeURIComponent(fastaText)}`
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showPredictionResults(result);
                } else {
                    alert('Prediction failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Prediction request failed: ' + error.message);
            } finally {
                // Restore button state
                predictBtn.innerHTML = originalText;
                predictBtn.disabled = false;
            }
        });
        
        // Export button click
        document.getElementById('exportBtn').addEventListener('click', function() {
            if (generatedSequences.length === 0) {
                alert('Please generate sequences first');
                return;
            }
            
            const data = generatedSequences.map(seq => ({
                id: seq.id,
                sequence: seq.sequence,
                length: seq.length,
                method: seq.method
            }));
            
            fetch('/export', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    format: 'csv',
                    results: data
                })
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'generated_sequences.csv';
                a.click();
                window.URL.revokeObjectURL(url);
            });
        });
        
        // Copy FASTA button click
        document.getElementById('copyBtn').addEventListener('click', function() {
            if (generatedSequences.length === 0) {
                alert('Please generate sequences first');
                return;
            }
            
            let fastaText = '';
            generatedSequences.forEach(seq => {
                fastaText += `>${seq.id}\n${seq.sequence}\n`;
            });
            
            navigator.clipboard.writeText(fastaText).then(() => {
                alert('FASTA sequences copied to clipboard');
            });
        });
        
        function showLoading() {
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';
            document.getElementById('generateBtn').disabled = true;
        }
        
        function showResults(result) {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';
            document.getElementById('generateBtn').disabled = false;
            
            // Display statistics
            const stats = `
                <div class="row text-center">
                    <div class="col-md-3">
                        <h6>Generated Sequences</h6>
                        <span class="badge bg-primary fs-6">${result.sequences.length}</span>
                    </div>
                    <div class="col-md-3">
                        <h6>Sampling Method</h6>
                        <span class="badge bg-info fs-6">${result.parameters.sampling_method}</span>
                    </div>
                    <div class="col-md-3">
                        <h6>Average Length</h6>
                        <span class="badge bg-success fs-6">${Math.round(result.sequences.reduce((sum, seq) => sum + seq.length, 0) / result.sequences.length)}</span>
                    </div>
                    <div class="col-md-3">
                        <h6>Temperature</h6>
                        <span class="badge bg-warning fs-6">${result.parameters.temperature}</span>
                    </div>
                </div>
            `;
            document.getElementById('generationStats').innerHTML = stats;
            
            // Display sequences
            let sequenceHtml = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>ID</th><th>Sequence</th><th>Length</th></tr></thead><tbody>';
            result.sequences.forEach(seq => {
                sequenceHtml += `
                    <tr>
                        <td><code>${seq.id}</code></td>
                        <td><code class="text-break">${seq.sequence}</code></td>
                        <td><span class="badge bg-secondary">${seq.length}</span></td>
                    </tr>
                `;
            });
            sequenceHtml += '</tbody></table></div>';
            document.getElementById('sequenceResults').innerHTML = sequenceHtml;
            
            document.getElementById('resultsSection').style.display = 'block';
        }
        
        function showError(message) {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('generateBtn').disabled = false;
            
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorSection').style.display = 'block';
        }
        
        function showPredictionResults(result) {
            const predictionContent = document.getElementById('predictionContent');
            
            // Statistics
            const stats = result.stats;
            let statsHtml = `
                <div class="row text-center mb-3">
                    <div class="col-md-3">
                        <h6>Total Sequences</h6>
                        <span class="badge bg-primary fs-6">${stats.total}</span>
                    </div>
                    <div class="col-md-3">
                        <h6>Positive Predictions</h6>
                        <span class="badge bg-success fs-6">${stats.positive}</span>
                    </div>
                    <div class="col-md-3">
                        <h6>Negative Predictions</h6>
                        <span class="badge bg-secondary fs-6">${stats.negative}</span>
                    </div>
                    <div class="col-md-3">
                        <h6>Average Probability</h6>
                        <span class="badge bg-info fs-6">${(stats.avg_probability * 100).toFixed(1)}%</span>
                    </div>
                </div>
            `;
            
            // Detailed results table
            let tableHtml = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Sequence ID</th>
                                <th>Sequence</th>
                                <th>Prediction</th>
                                <th>Confidence</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            result.results.forEach(item => {
                const probability = (item.probability * 100).toFixed(1);
                const badgeClass = item.prediction === 1 ? 'bg-success' : 'bg-secondary';
                const statusIcon = item.prediction === 1 ? 'bi-check-circle' : 'bi-x-circle';
                
                tableHtml += `
                    <tr>
                        <td><code>${item.id}</code></td>
                        <td><code class="text-break" style="font-size: 0.8em;">${item.sequence}</code></td>
                        <td><span class="badge ${badgeClass}">${item.label}</span></td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar ${item.prediction === 1 ? 'bg-success' : 'bg-secondary'}"
                                     style="width: ${probability}%">${probability}%</div>
                            </div>
                        </td>
                        <td><i class="bi ${statusIcon} ${item.prediction === 1 ? 'text-success' : 'text-secondary'}"></i></td>
                    </tr>
                `;
            });
            
            tableHtml += '</tbody></table></div>';
            
            predictionContent.innerHTML = statsHtml + tableHtml;
            document.getElementById('predictionResults').style.display = 'block';
            
            // 滚动到预测结果
            document.getElementById('predictionResults').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
    </script>
</body>
</html>